<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sehat Setu ‚Äî Clean Prototype</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Font Awesome (icons) -->
  <script src="https://kit.fontawesome.com/6d42e9e0ce.js" crossorigin="anonymous"></script>

  <!-- Chart.js for IoT charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand: #2a9d8f;
      --accent:#e76f51;
      --muted:#6c757d;
      --glass: rgba(255,255,255,0.7);
      --bg: #f6f8fa;
      --card: #ffffff;
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',system-ui,Arial;margin:0;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
    .app{display:flex;min-height:100vh}
    /* Sidebar */
    .sidebar{width:240px;background:linear-gradient(180deg,var(--brand),#1e6b60);color:white;padding:18px;display:flex;flex-direction:column;gap:12px}
    .brand{font-weight:700;font-size:18px}
    .muted{color:rgba(255,255,255,0.9);font-size:13px}
    .nav{margin-top:12px;display:flex;flex-direction:column;gap:6px}
    .nav button{background:transparent;border:none;color:inherit;text-align:left;padding:10px;border-radius:8px;cursor:pointer;display:flex;gap:10px;align-items:center;font-weight:600}
    .nav button.active{background:rgba(255,255,255,0.08)}
    .sidebar-footer{margin-top:auto;font-size:12px;opacity:0.95}
    /* Main */
    .main{flex:1;padding:18px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--brand),#21867a);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .mini{background:#fff;border:1px solid #ddd;padding:8px 10px;border-radius:8px;color:var(--brand);cursor:pointer}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 8px 28px rgba(12,18,24,0.06)}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-top:14px}
    @media(max-width:980px){ .sidebar{display:none} .grid{grid-template-columns:1fr} }
    h2{margin:0 0 8px 0}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0}
    textarea{min-height:90px;resize:vertical}
    .muted-dark{color:var(--muted);font-size:13px}

    /* Chat */
    .chat{display:flex;flex-direction:column;height:420px}
    .messages{flex:1;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg,#f7fffb,#f0f9f8)}
    .msg{display:flex;margin:8px 0}
    .msg.bot .bubble{background:#eef7f6;color:#06372f}
    .msg.user{justify-content:flex-end}
    .bubble{padding:8px 12px;border-radius:12px;max-width:78%}
    .chat-controls{display:flex;gap:8px;margin-top:8px}

    /* IoT chart */
    #iotChart{max-width:100%;height:240px}

    /* toast */
    #toast{position:fixed;right:20px;bottom:20px;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:all .28s;z-index:999}

    /* dark */
    body.dark{background:#071023;color:#e6f0f6}
    body.dark .card{background:#071826;box-shadow:0 8px 30px rgba(0,0,0,0.45)}
    body.dark input,body.dark textarea{background:#05232b;color:#cfe8e5;border:1px solid rgba(255,255,255,0.04)}
    a{color:var(--brand)}
    small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">Sehat Setu</div>
      <div class="muted">Multilingual ‚Ä¢ Demo ‚Ä¢ Local data</div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="mini" id="darkToggle">üåô</button>
        <button class="mini" id="langToggle">EN</button>
      </div>

      <nav class="nav" id="nav">
        <button class="active" data-view="dashboard"><i class="fas fa-th-large"></i> Dashboard</button>
        <button data-view="video"><i class="fas fa-video"></i> Video</button>
        <button data-view="chatbot"><i class="fas fa-robot"></i> Chatbot</button>
        <button data-view="records"><i class="fas fa-file-medical"></i> Records</button>
        <button data-view="iot"><i class="fas fa-microchip"></i> IoT</button>
        <button data-view="emergency"><i class="fas fa-ambulance"></i> Emergency</button>
      </nav>

      <div class="sidebar-footer">¬© Nabha Prototype ‚Äî Demo</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div><h2 style="margin:0">Sehat Setu</h2><small class="muted-dark">Single-file prototype ‚Äî replace with backend for production</small></div>
        <div class="controls"><div id="activityShort" class="muted-dark">No activity</div></div>
      </div>

      <section id="views">
        <!-- Dashboard -->
        <div id="dashboard" class="view">
          <div class="grid">
            <div>
              <div class="card">
                <h2>Welcome üëã</h2>
                <p class="muted-dark">Use left menu to navigate features. App saves demo data in your browser's localStorage.</p>
                <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn" onclick="openView('video')"><i class="fas fa-video"></i> Start Video</button>
                  <button class="btn" onclick="openView('chatbot')"><i class="fas fa-robot"></i> Open Chatbot</button>
                  <button class="mini" onclick="openView('records')"><i class="fas fa-file-medical"></i> Records</button>
                </div>
              </div>

              <div class="card" style="margin-top:12px">
                <h3>Activity Log</h3>
                <div id="activityList" class="muted-dark" style="max-height:220px;overflow:auto;margin-top:8px">No activity yet.</div>
              </div>
            </div>

            <aside>
              <div class="card">
                <h3>Emergency Quick</h3>
                <p class="muted-dark">One-tap call (demo)</p>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <a href="tel:108"><button class="btn">Call 108</button></a>
                  <button class="mini" onclick="showAmbulanceInfo()">More</button>
                </div>
              </div>

              <div class="card" style="margin-top:12px">
                <h3>Stats</h3>
                <div style="display:flex;gap:16px;margin-top:8px">
                  <div><strong id="statRecords">0</strong><div class="muted-dark">Records</div></div>
                  <div><strong id="statPresc">0</strong><div class="muted-dark">Prescriptions</div></div>
                </div>
              </div>
            </aside>
          </div>
        </div>

        <!-- Video -->
        <div id="video" class="view" style="display:none">
          <div class="card">
            <h2>Video Consultation ‚Äî Local Demo</h2>
            <p class="muted-dark">This preview uses your camera locally. For real consults integrate WebRTC + signaling servers.</p>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn" id="startCam">Start Camera</button>
              <button class="mini" id="stopCam">Stop</button>
              <button class="mini" onclick="openWaitingRoom()">Open Waiting Room</button>
            </div>

            <div id="videoArea" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap"></div>
          </div>
        </div>

        <!-- Chatbot -->
        <div id="chatbot" class="view" style="display:none">
          <div class="card chat">
            <h2>AI Symptom Checker</h2>
            <small class="muted-dark">Type symptoms in English / ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä. For production, connect an AI backend.</small>

            <div id="messages" class="messages" style="margin-top:10px">
              <div class="msg bot"><div class="bubble">‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‚Äî ‡§Ö‡§™‡§®‡•Ä symptoms ‡§¨‡§§‡§æ‡§á‡§è / Type symptoms (e.g. fever)</div></div>
            </div>

            <div class="chat-controls" style="margin-top:10px">
              <input id="chatInput" placeholder="Type symptoms (English / ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)" />
              <button class="mini" id="voiceBtn"><i class="fas fa-microphone"></i></button>
              <button class="btn" id="sendBtn">Send</button>
            </div>
          </div>
        </div>

        <!-- Records -->
        <div id="records" class="view" style="display:none">
          <div class="card">
            <h2>Digital Health Records & e-Prescriptions</h2>
            <small class="muted-dark">Records saved locally (demo). Export to PDF or JSON for backup.</small>

            <div style="margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:12px">
              <div>
                <input id="recName" placeholder="Patient name" />
                <textarea id="recNotes" placeholder="Notes / complaints" style="margin-top:8px"></textarea>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn" id="saveRecordBtn">Save Record</button>
                  <button class="mini" id="exportRecordPDFBtn">Export PDF</button>
                  <button class="mini" id="downloadRecordsBtn">Download JSON</button>
                </div>

                <hr style="margin:12px 0" />
                <h4>Quick Prescription</h4>
                <input id="presName" placeholder="Patient name" />
                <input id="presMed" placeholder="Medicine & dose (e.g. Paracetamol 500mg)" style="margin-top:8px" />
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn" id="savePrescBtn">Save Prescription</button>
                  <button class="mini" id="prescPdfBtn">PDF</button>
                </div>
              </div>

              <aside>
                <div class="card">
                  <h4>Recent Records</h4>
                  <div id="recordsList" style="margin-top:8px;max-height:220px;overflow:auto" class="muted-dark">No records</div>
                </div>

                <div class="card" style="margin-top:12px">
                  <h4>Recent Prescriptions</h4>
                  <div id="presList" style="margin-top:8px;max-height:120px;overflow:auto" class="muted-dark">No prescriptions</div>
                </div>
              </aside>
            </div>
          </div>
        </div>

        <!-- IoT -->
        <div id="iot" class="view" style="display:none">
          <div class="card">
            <h2>IoT Device Simulation</h2>
            <small class="muted-dark">Simulate BP / Glucose / ECG and sync to records.</small>

            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn" id="simBP">Simulate BP</button>
              <button class="mini" id="simGlucose">Simulate Glucose</button>
              <button class="mini" id="simECG">Simulate ECG</button>
              <button class="mini" id="syncDevice">Sync to Latest Record</button>
            </div>

            <canvas id="iotChart" style="margin-top:12px"></canvas>
            <div id="iotText" class="muted-dark" style="margin-top:10px">No device readings yet.</div>
          </div>
        </div>

        <!-- Emergency -->
        <div id="emergency" class="view" style="display:none">
          <div class="card">
            <h2>Emergency</h2>
            <small class="muted-dark">Call local ambulance. This is a demo link.</small>
            <div style="display:flex;gap:8px;margin-top:12px">
              <a href="tel:108"><button class="btn">Call 108</button></a>
              <button class="mini" onclick="showAmbulanceInfo()">More Info</button>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <div id="toast">Notification</div>

  <script>
    /* ---------------------------
       Lightweight single-file app
       --------------------------- */

    // Keys for localStorage
    const RECORDS_KEY = 'nabha_records_v3';
    const PRESC_KEY = 'nabha_presc_v3';

    // DOM helpers
    const toastEl = document.getElementById('toast');
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.opacity = 1;
      toastEl.style.transform = 'translateY(0)';
      setTimeout(()=>{ toastEl.style.opacity = 0; toastEl.style.transform = 'translateY(8px)'; }, 2000);
    }

    function logActivity(text){
      const el = document.getElementById('activityList');
      const ts = new Date().toLocaleString();
      el.innerHTML = `<div>${ts}: ${escapeHtml(text)}</div>` + el.innerHTML;
      document.getElementById('activityShort').textContent = text;
    }
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

    // Simple view router
    document.querySelectorAll('.nav button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        openView(btn.dataset.view);
      });
    });
    function openView(id){
      document.querySelectorAll('.view').forEach(v=>v.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      logActivity('Opened view: ' + id);
    }

    // Toggle dark & language
    document.getElementById('darkToggle').addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
    });
    const langBtn = document.getElementById('langToggle');
    let lang = 'en';
    langBtn.addEventListener('click', ()=>{
      lang = lang === 'en' ? 'hi' : 'en';
      langBtn.textContent = lang.toUpperCase();
      showToast('Language: ' + lang.toUpperCase());
    });

    /* ---------------------------
       Video (local camera preview)
       --------------------------- */
    let localStream = null;
    document.getElementById('startCam').addEventListener('click', startCamera);
    document.getElementById('stopCam').addEventListener('click', stopCamera);

    async function startCamera(){
      try{
        const s = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        localStream = s;
        const area = document.getElementById('videoArea'); area.innerHTML = '';
        const v = document.createElement('video'); v.autoplay = true; v.playsInline = true; v.muted = true;
        v.srcObject = s; v.style.width = '320px'; v.style.borderRadius = '8px';
        area.appendChild(v);
        showToast('Camera started');
        logActivity('Camera started');
      }catch(e){
        alert('Camera access denied or not available');
      }
    }
    function stopCamera(){
      if(localStream) localStream.getTracks().forEach(t=>t.stop());
      localStream = null;
      document.getElementById('videoArea').innerHTML = '';
      showToast('Camera stopped');
      logActivity('Camera stopped');
    }
    function openWaitingRoom(){ window.open('', '_blank', 'width=700,height=520').document.write('<h3 style=\"font-family:Poppins\">Waiting Room (placeholder)</h3><p>Integrate WebRTC for real remote consults.</p>'); }

    /* ---------------------------
       Chatbot (rule-based, multilingual)
       --------------------------- */
    const messagesEl = document.getElementById('messages');
    document.getElementById('sendBtn').addEventListener('click', sendChat);
    document.getElementById('voiceBtn').addEventListener('click', startVoice);

    function appendUserMsg(txt){
      const d = document.createElement('div'); d.className = 'msg user';
      d.innerHTML = `<div class="bubble">${escapeHtml(txt)}</div>`;
      messagesEl.appendChild(d); messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function appendBotMsg(txt){
      const d = document.createElement('div'); d.className = 'msg bot';
      d.innerHTML = `<div class="bubble">${escapeHtml(txt)}</div>`;
      messagesEl.appendChild(d); messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function detectLangFromText(t){
      if(/[\u0900-\u097F]/.test(t)) return 'hi';
      return 'en';
    }

    function ruleBasedReply(text, l){
      const t = text.toLowerCase();
      if(/(fever|bukhar|‡§¨‡•Å‡§ñ‡§æ‡§∞)/.test(t)) {
        return l==='hi' ? '‡§¨‡•Å‡§ñ‡§æ‡§∞ 2 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§π‡•ã ‡§§‡•ã ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å‡•§ ‡§™‡•á‡§∞‡§æ‡§∏‡§ø‡§ü‡§æ‡§Æ‡•ã‡§≤ ‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§Ü‡§∞‡§æ‡§Æ ‡§ï‡§∞‡•á‡§Ç‡•§' : 'If fever >2 days, consult a doctor. Take paracetamol and rest.';
      }
      if(/(dengue|‡§°‡•á‡§Ç‡§ó‡•Ç)/.test(t)) {
        return l==='hi' ? '‡§°‡•á‡§Ç‡§ó‡•Ç ‡§ï‡•á ‡§≤‡§ï‡•ç‡§∑‡§£: ‡§§‡•á‡§ú ‡§¨‡•Å‡§ñ‡§æ‡§∞, ‡§ú‡•ã‡§°‡§º‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§¶ ‚Äî ‡§¨‡•ç‡§≤‡§° ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ‡§è‡§Å‡•§' : 'Dengue symptoms include high fever and body ache ‚Äî get a blood test.';
      }
      if(/(cough|khaansi|‡§ñ‡§æ‡§Ç‡§∏‡•Ä)/.test(t)) {
        return l==='hi' ? '‡§Ö‡§ó‡§∞ ‡§ñ‡§æ‡§Ç‡§∏‡•Ä ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§∞‡§π‡•á ‡§§‡•ã ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å ‡§î‡§∞ ‡§ó‡§∞‡§Æ ‡§™‡§æ‡§®‡•Ä ‡§™‡§ø‡§è‡§Å‡•§' : 'If cough persists, see a doctor and stay hydrated.';
      }
      if(/(help|madad|‡§∏‡§π‡§æ‡§Ø‡§§‡§æ)/.test(t)) {
        return l==='hi' ? '‡§Æ‡•à‡§Ç ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å ‡§î‡§∞ ‡§™‡§æ‡§∏ ‡§ï‡•á ‡§π‡•á‡§≤‡•ç‡§™‡§≤‡§æ‡§á‡§® ‡§¶‡§ø‡§ñ‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§' : 'I can save records and show emergency helplines.';
      }
      return l==='hi' ? '‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§∏‡§Ç‡§ï‡•ç‡§∑‡•á‡§™ ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§' : 'Please describe your symptoms briefly.';
    }

    async function sendChat(){
      const input = document.getElementById('chatInput');
      const txt = input.value.trim(); if(!txt) return;
      appendUserMsg(txt); input.value = '';
      // typing indicator
      const typing = document.createElement('div'); typing.className = 'msg bot'; typing.id = 'typing'; typing.innerHTML = `<div class="bubble">...</div>`; messagesEl.appendChild(typing); messagesEl.scrollTop = messagesEl.scrollHeight;
      const detected = detectLangFromText(txt);
      setTimeout(()=>{
        typing.remove();
        const reply = ruleBasedReply(txt, detected);
        appendBotMsg(reply);
        logActivity('Chatbot answered');
      }, 700);
    }

    // voice input (basic)
    let recognition;
    function startVoice(){
      if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return alert('Speech recognition not supported on this browser');
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = (lang === 'hi' ? 'hi-IN' : 'en-IN');
      recognition.interimResults = false; recognition.maxAlternatives = 1;
      recognition.onresult = e => { const t = e.results[0][0].transcript; document.getElementById('chatInput').value = t; sendChat(); }
      recognition.onerror = e => showToast('Voice error: ' + e.error);
      recognition.start();
    }

    /* ---------------------------
       Records & Prescriptions
       --------------------------- */
    function getRecords(){ return JSON.parse(localStorage.getItem(RECORDS_KEY) || '[]'); }
    function saveRecords(arr){ localStorage.setItem(RECORDS_KEY, JSON.stringify(arr)); renderRecords(); updateStats(); }

    function getPresc(){ return JSON.parse(localStorage.getItem(PRESC_KEY) || '[]'); }
    function savePresc(arr){ localStorage.setItem(PRESC_KEY, JSON.stringify(arr)); renderPresc(); updateStats(); }

    document.getElementById('saveRecordBtn').addEventListener('click', ()=>{
      const name = document.getElementById('recName').value.trim();
      const notes = document.getElementById('recNotes').value.trim();
      if(!name) return alert('Enter patient name');
      const arr = getRecords();
      arr.unshift({id:Date.now(), name, notes, created: new Date().toISOString(), devices: []});
      saveRecords(arr);
      document.getElementById('recName').value = ''; document.getElementById('recNotes').value = '';
      showToast('Record saved');
      logActivity('Saved record: ' + name);
    });

    document.getElementById('exportRecordPDFBtn').addEventListener('click', ()=>{
      const arr = getRecords(); if(arr.length===0) return alert('No records');
      const r = arr[0];
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      doc.setFontSize(14); doc.text('Health Record', 14, 20);
      doc.setFontSize(12); doc.text(`Name: ${r.name}`, 14, 32);
      doc.text(`Created: ${new Date(r.created).toLocaleString()}`, 14, 40);
      doc.text('Notes:', 14, 50); doc.setFontSize(11); doc.text(r.notes || '-', 14, 60, { maxWidth: 180 });
      doc.save('health-record.pdf'); showToast('Record exported (PDF)');
    });

    document.getElementById('downloadRecordsBtn').addEventListener('click', ()=>{
      const data = localStorage.getItem(RECORDS_KEY) || '[]';
      const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'nabha_records.json'; a.click(); URL.revokeObjectURL(url);
      showToast('Records downloaded');
    });

    document.getElementById('savePrescBtn').addEventListener('click', ()=>{
      const name = document.getElementById('presName').value.trim(); const med = document.getElementById('presMed').value.trim();
      if(!name || !med) return alert('Enter prescription details');
      const arr = getPresc(); arr.unshift({id:Date.now(), name, med, doctor: 'Dr. Demo', created: new Date().toISOString()});
      savePresc(arr); document.getElementById('presName').value = ''; document.getElementById('presMed').value = '';
      showToast('Prescription saved'); logActivity('Saved prescription: ' + name);
    });

    document.getElementById('prescPdfBtn').addEventListener('click', ()=>{
      const arr = getPresc(); if(arr.length===0) return alert('No prescriptions');
      const p = arr[0]; const { jsPDF } = window.jspdf; const doc = new jsPDF();
      doc.setFontSize(16); doc.text('e-Prescription', 14, 20);
      doc.setFontSize(12); doc.text(`Patient: ${p.name}`, 14, 36); doc.text(`Doctor: ${p.doctor}`, 14, 44); doc.text(`Prescription: ${p.med}`, 14, 52);
      doc.save('prescription.pdf'); showToast('Prescription PDF generated');
    });

    function renderRecords(){
      const el = document.getElementById('recordsList');
      const arr = getRecords();
      if(arr.length === 0){ el.innerHTML = '<div class="muted-dark">No records</div>'; return; }
      el.innerHTML = arr.map(r => `
        <div style="border:1px solid #eef4f3;padding:8px;border-radius:8px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${escapeHtml(r.name)}</strong><div class="muted-dark">${new Date(r.created).toLocaleString()}</div></div>
            <div>
              <button class="mini" onclick="viewRecord(${r.id})">View</button>
              <button class="mini" onclick="attachDevice(${r.id})">Attach Device</button>
            </div>
          </div>
          <div style="margin-top:8px">${escapeHtml(r.notes)}</div>
        </div>
      `).join('');
    }
    function renderPresc(){
      const el = document.getElementById('presList'); const arr = getPresc();
      if(arr.length === 0){ el.innerHTML = '<div class="muted-dark">No prescriptions</div>'; return; }
      el.innerHTML = arr.map(p => `
        <div style="border:1px solid #eef4f3;padding:8px;border-radius:8px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${escapeHtml(p.name)}</strong><div class="muted-dark">${new Date(p.created).toLocaleString()}</div></div>
            <div><button class="mini" onclick="downloadSpecificPresc(${p.id})">PDF</button></div>
          </div>
          <div style="margin-top:8px">${escapeHtml(p.med)}</div>
        </div>
      `).join('');
    }
    async function downloadSpecificPresc(id){
      const arr = getPresc(); const p = arr.find(x=>x.id===id) || arr[0]; if(!p) return;
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      doc.setFontSize(16); doc.text('e-Prescription', 14, 20);
      doc.setFontSize(12); doc.text(`Patient: ${p.name}`, 14, 36); doc.text(`Doctor: ${p.doctor}`, 14, 44); doc.text(`Prescription: ${p.med}`, 14, 52);
      doc.save('prescription.pdf'); showToast('PDF generated');
    }

    // helper to view record
    window.viewRecord = function(id){
      const rec = getRecords().find(r => r.id === id);
      if(!rec) return alert('Not found');
      alert(`Name: ${rec.name}\nCreated: ${new Date(rec.created).toLocaleString()}\nNotes: ${rec.notes}\nDevices: ${JSON.stringify(rec.devices || [], null, 2)}`);
    };

    /* ---------------------------
       IoT simulation & Chart.js
       --------------------------- */
    const ctx = document.getElementById('iotChart').getContext('2d');
    const iotState = {labels: [], sys: [], glucose: []};
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: iotState.labels,
        datasets: [
          { label: 'BP (systolic)', data: iotState.sys, tension: .3, borderWidth: 2, pointRadius: 2, borderColor: '#ff7f50' },
          { label: 'Glucose (mg/dL)', data: iotState.glucose, tension: .3, borderWidth: 2, pointRadius: 2, borderColor: '#4169e1' }
        ]
      },
      options: { responsive: true, plugins:{legend:{position:'bottom'}} }
    });

    let lastDeviceReading = null;
    document.getElementById('simBP').addEventListener('click', ()=>{
      const sys = 100 + Math.floor(Math.random()*40); const dia = 60 + Math.floor(Math.random()*25);
      lastDeviceReading = {type:'BP', sys, dia}; document.getElementById('iotText').textContent = `BP: ${sys}/${dia} mmHg`;
      pushIotPoint(sys, null); showToast('BP simulated'); logActivity('Simulated BP ' + sys + '/' + dia);
    });
    document.getElementById('simGlucose').addEventListener('click', ()=>{
      const g = 70 + Math.floor(Math.random()*120); lastDeviceReading = {type:'Glucose', mgdl:g};
      document.getElementById('iotText').textContent = `Glucose: ${g} mg/dL`; pushIotPoint(null, g); showToast('Glucose simulated'); logActivity('Simulated Glucose ' + g);
    });
    document.getElementById('simECG').addEventListener('click', ()=>{
      const rhythms = ['Normal sinus rhythm','Sinus tachycardia','Atrial fibrillation (suspected)'];
      const pick = rhythms[Math.floor(Math.random()*rhythms.length)]; lastDeviceReading = {type:'ECG', summary: pick};
      document.getElementById('iotText').textContent = `ECG: ${pick}`; showToast('ECG simulated'); logActivity('Simulated ECG: ' + pick);
    });
    document.getElementById('syncDevice').addEventListener('click', ()=>{
      const arr = getRecords(); if(arr.length === 0) return alert('No records. Save a record first.');
      attachDevice(arr[0].id);
    });

    function pushIotPoint(sys, glucose){
      const t = new Date().toLocaleTimeString();
      iotState.labels.push(t);
      iotState.sys.push(sys === null ? NaN : sys);
      iotState.glucose.push(glucose === null ? NaN : glucose);
      if(iotState.labels.length > 12){
        iotState.labels.shift(); iotState.sys.shift(); iotState.glucose.shift();
      }
      chart.update();
    }

    function attachDevice(recordId){
      const arr = getRecords(); const rec = arr.find(r=>r.id === recordId);
      if(!rec) return alert('Record not found');
      if(!lastDeviceReading) return alert('No device reading present. Simulate device first.');
      rec.devices = rec.devices || []; rec.devices.push({...lastDeviceReading, ts: new Date().toISOString()});
      saveRecords(arr); showToast('Device synced to record'); logActivity('Device attached to ' + rec.name);
    }

    /* ---------------------------
       Emergency
       --------------------------- */
    function showAmbulanceInfo(){ alert('Emergency numbers:\\n108 ‚Äî State Ambulance\\n102 ‚Äî Medical emergency\\nLocal hospital: +91 12345 67890\\n(Replace with real numbers in production)'); logActivity('Viewed ambulance info'); }

    /* ---------------------------
       Stat updates & init
       --------------------------- */
    function updateStats(){ document.getElementById('statRecords').textContent = getRecords().length; document.getElementById('statPresc').textContent = getPresc().length; }
    function init(){
      if(!localStorage.getItem(RECORDS_KEY)) localStorage.setItem(RECORDS_KEY, JSON.stringiffhy([]));
      if(!localStorage.getItem(PRESC_KEY)) localStorage.setItem(PRESC_KEY, JSON.stringify([]));
      renderRecords(); renderPresc(); updateStats(); openView('dashboard'); logActivity('App loaded');
    }
    init();

    // Expose small helpers for console debugging (optional)
    window.openView = openView;
    window.attachDevice = attachDevice;
    window.viewRecord = window.viewRecord; // already defined
  </script>
</body>
</html>
